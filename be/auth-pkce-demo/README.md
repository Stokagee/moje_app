# OAuth2 PKCE Flow Demo

Demo aplikace pro **OAuth2 PKCE (Proof Key for Code Exchange)** flow - autorizace pro veřejné klienty (SPA, mobilní apps).

## Co je PKCE?

PKCE (pronounced "pixie") rozšiřuje OAuth2 Authorization Code flow pro aplikace, které **nemohou bezpečně uložit client_secret**:

- **Single Page Applications** (React, Vue, Angular, Svelte)
- **Mobile apps** (iOS, Android, React Native)
- **Desktop aplikace** (Electron, Tauri)

### Problém který řeší

V klasickém Authorization Code flow:
- Server-side klient má tajný `client_secret`
- Secret slouží jako důkaz identity klienta
- Ale v browseru/mobile app nelze bezpečně uložit secret

Řešení PKCE:
- Klient generuje náhodný `code_verifier`
- Z verifieru vypočítá `code_challenge = SHA256(verifier)`
- Challenge se pošle v authorize requestu
- Při token exchange klient prokáže, že zná původní verifier
- Server ověří: `SHA256(verifier) == stored_challenge`

## Architektura

```
┌─────────────────────────────────────────────────────────────────────┐
│                         PKCE Flow                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  1. CLIENT                                                      AUTH SERVER │
│     ├─ Generate: verifier = random()                          │
│     ├─ Calculate: challenge = SHA256(verifier)                 │
│     └─ Redirect: /oauth2/authorize?code_challenge=X            │
│                                                                     │
│  2. AUTH SERVER                                                     │
│     ├─ Validate client, redirect_uri, challenge                  │
│     └─ Show consent page to user                                 │
│                                                                     │
│  3. USER                                                            │
│     └─ Approve consent                                            │
│                                                                     │
│  4. AUTH SERVER                                                     │
│     ├─ Generate: auth_code = random()                            │
│     ├─ Store: {code_challenge, user_id, scopes}                 │
│     └─ Redirect: callback?code=Y                                │
│                                                                     │
│  5. CLIENT                                                      AUTH SERVER │
│     └─ POST /oauth2/token:                                       │
│        {code, code_verifier, client_id}                          │
│                                                                     │
│  6. AUTH SERVER                                                     │
│     ├─ Retrieve: stored_challenge = get(code)                   │
│     ├─ Verify: SHA256(verifier) == stored_challenge             │
│     ├─ If valid: Generate access_token                          │
│     └─ Return: {access_token, token_type, expires_in}           │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## Srovnání: Authorization Code vs PKCE

| Aspect | Authorization Code | PKCE |
|--------|-------------------|------|
| **Client type** | Confidential (server) | Public (SPA/mobile) |
| **Client secret** | Required | ❌ Not used |
| **Code verifier** | ❌ Not used | ✅ Generated by client |
| **Code challenge** | ❌ Not used | ✅ Sent in authorize |
| **Security basis** | Secret proves identity | Verifier proves identity |
| **Use cases** | Server apps, backend services | SPA, mobile, desktop |

## Endpointy

| Endpoint | Method | Popis |
|----------|--------|-------|
| `/` | GET | API info a dokumentace |
| `/health` | GET | Health check |
| `/oauth2/authorize` | GET | Consent stránka s `code_challenge` |
| `/oauth2/approve` | POST | Schválení consentu |
| `/oauth2/token` | POST | Exchange code za token (s `code_verifier`) |
| `/oauth2/userinfo` | GET | Získat user info |
| `/oauth2/pkce/demo` | GET | Demo endpoint pro PKCE generování |

## Demo Credentials

### User
```
username: demo
password: demo123
```

### Public Client (PKCE)
```
client_id: pkce-spa-client
client_secret: None (public client!)
redirect_uri: http://localhost:3000/callback
scopes: read write
```

## Lokální spuštění

### Bez Docker

```bash
# 1. Install dependencies
pip install -r requirements.txt

# 2. Start Redis (required for auth codes)
redis-server

# 3. Run application
uvicorn app.main:app --reload --port 11004

# 4. Access Swagger UI
open http://localhost:11004/docs
```

### S Docker

```bash
# Build a start
docker compose up -d --build auth-pkce-demo

# Zkontrolovat status
docker compose ps auth-pkce-demo

# Logy
docker logs moje_app_auth_pkce_demo
```

URLs:
- **API**: http://localhost:11004
- **Swagger**: http://localhost:11004/docs
- **Health**: http://localhost:11004/health

## PKCE Flow Example

### 1. Generovat PKCE pair (klient)

```javascript
// Client-side JavaScript
function generatePKCEPair() {
    // Generate verifier (43-128 chars)
    const verifier = base64UrlEncode(crypto.randomBytes(32));

    // Calculate challenge
    const challenge = base64UrlEncode(
        crypto.subtle.digest('SHA-256', verifier)
    );

    return { verifier, challenge };
}

const { verifier, challenge } = generatePKCEPair();
```

Python:
```python
import secrets, hashlib, base64

def generate_pkce_pair():
    verifier = base64.urlsafe_b64encode(secrets.token_bytes(32)).decode().rstrip('=')
    challenge = base64.urlsafe_b64encode(
        hashlib.sha256(verifier.encode()).digest()
    ).decode().rstrip('=')
    return verifier, challenge
```

### 2. Authorize request (s code_challenge)

```
GET /oauth2/authorize?
    client_id=pkce-spa-client&
    redirect_uri=http://localhost:3000/callback&
    response_type=code&
    code_challenge=E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM&
    code_challenge_method=S256&
    scope=read&
    state=random123
```

### 3. User approves consent

```http
POST /oauth2/approve
Content-Type: application/x-www-form-urlencoded

client_id=pkce-spa-client
&redirect_uri=http://localhost:3000/callback
&code_challenge=E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM
&username=demo
&password=demo123
&scopes=read
```

### 4. Redirect s authorization code

```
HTTP 302 Found
Location: http://localhost:3000/callback?code=AUTH_CODE&state=random123
```

### 5. Token exchange (s code_verifier)

```http
POST /oauth2/token
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code
&code=AUTH_CODE
&client_id=pkce-spa-client
&code_verifier=ORIGINAL_VERIFIER
&redirect_uri=http://localhost:3000/callback
```

Response:
```json
{
  "access_token": "eyJ...",
  "token_type": "bearer",
  "expires_in": 3600,
  "scope": "read"
}
```

### 6. Access protected resource

```http
GET /oauth2/userinfo
Authorization: Bearer eyJ...
```

## Testování

```bash
# Run tests
pytest tests/ -v

# Run specific test
pytest tests/test_pkce_flow.py::TestPKCEFlow::test_complete_pkce_flow -v

# Run with coverage
pytest tests/ --cov=app --cov-report=html
```

## Security Poznámky

### ✅ Vždy vyžadovat S256
- Odmítnout `plain` metodu (insecure)
- Pouze `SHA256` je bezpečný

### ✅ Enforce code_challenge
- Odmítnout authorize requesty bez challenge
- Challenge musí být správného formátu

### ✅ Strict verifier validation
- Použít přesné porovnání hashů
- Constant-time comparison pro prevenci timing attacks

### ✅ Krátka expirace codes
- 10 minut max (default)
- Jednorázové použití

### ✅ Single-use codes
- Smazat po token exchange
- Zabránit replay attacks

## Integrace do SPA (Příklad)

```javascript
// React example
import { generatePKCEPair } from './pkce-utils';

async function login() {
    // 1. Generate PKCE pair
    const { verifier, challenge } = generatePKCEPair();
    sessionStorage.setItem('code_verifier', verifier);

    // 2. Redirect to authorize
    const params = new URLSearchParams({
        client_id: 'pkce-spa-client',
        redirect_uri: 'http://localhost:3000/callback',
        response_type: 'code',
        code_challenge: challenge,
        code_challenge_method: 'S256'
    });

    window.location.href = `/oauth2/authorize?${params}`;
}

// Callback component
async function handleCallback() {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const verifier = sessionStorage.getItem('code_verifier');

    // Exchange code for token
    const response = await fetch('/oauth2/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
            grant_type: 'authorization_code',
            code,
            client_id: 'pkce-spa-client',
            code_verifier: verifier,
            redirect_uri: 'http://localhost:3000/callback'
        })
    });

    const { access_token } = await response.json();
    // Use access_token...
}
```

## Reference

- [RFC 7636: PKCE](https://datatracker.ietf.org/doc/html/rfc7636)
- [OAuth 2.0 for Browser-Based Apps](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-browser-based-apps)
- [PKCE Explained](https://www.oauth.com/oauth2-servers/pkce/)
